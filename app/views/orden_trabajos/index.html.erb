<p id="notice"><%= notice %></p>

<div class="d-flex justify-content-between align-items-center mb-3">
  <!-- 🧮 Contador -->
  <div class="ml-3">
    <h3 class="mb-0">
      Planilla de control:
      <button type="button" class="btn btn-dark btn-sm ms-2">
        <strong><%= @contador %></strong>
      </button>
    </h3>
  </div>
  <!-- 💡 Script de búsqueda -->
  <script type="module">
    document.addEventListener("turbo:load", () => {
      const $buscador = $("#buscador_datos");
      const $filas = $("#TablaOrdenesTrabajos tr");

      if ($buscador.length && $filas.length) {
        $buscador.on("keyup", function() {
          const value = $(this).val().toLowerCase().trim();

          $filas.each(function() {
            const textoFila = $(this).text().toLowerCase();
            $(this).toggle(textoFila.includes(value));
          });
        });
      }
    });
  </script>
  <!-- 🔍 Buscador de trabajos -->
  <div class="flex-grow-1 text-center">
    <input class="form-control d-inline-block w-50"
           id="buscador_datos"
           type="text"
           placeholder="Buscar trabajo...">
  </div>
  <!-- ➕ Nuevo trabajo -->
  <div class="me-3">
    <%= link_to '+ Nuevo trabajo', new_orden_trabajo_path, class: 'btn btn-success btn-lg' %>
  </div>
</div>

<!-- Botón para volver arriba -->
<button onclick="topFunction()" id="myBtn" title="Volver arriba"
        class="btn btn-danger shadow fw-bold text-white"
        style="display:none; position:fixed; bottom:40px; right:40px; z-index:9999;
               border-radius:8px; padding:10px 20px; font-size:16px;">
  Tira Mi Su
</button>
<!-- Tabla principal -->
<table class="table table-striped m-2">
  <thead>
    <tr>
      <th>Ot</th>
      <th>Cliente</th>
      <th>Producto</th>
      <th>Cantidad</th>
      <th>Estado actual</th>
      <th>Proceso</th>
      <th>Fecha entrega</th>
      <th>Observaciones</th>
      <th colspan="3"></th>
    </tr>
  </thead>
  <tbody id="TablaOrdenesTrabajos">
    <% @orden_trabajos.each do |orden_trabajo| %>
      <tr id="<%= dom_id(orden_trabajo) %>" data-controller="orders" data-target="orders.row">
        <%= simple_form_for orden_trabajo, html: { data: { action: "ajax:success->form#onPostSuccess" } } do |f| %>        
          <!-- OT -->
          <td>
            <button type="button"
                    class="btn btn-info btn-sm"
                    data-action="click->orders#copy"
                    data-id="<%= orden_trabajo.id %>">
              <%= orden_trabajo.trnum %>
            </button>
          </td>

          <!-- Cliente -->
          <td><%= link_to orden_trabajo.clinom, orden_trabajo_path(orden_trabajo) %></td>

          <!-- Producto -->
          <td><%= orden_trabajo.nomprod.first(30) %></td>

          <!-- Cantidad -->
          <td width="1" class="text-center" style="width:5%">
            <%= orden_trabajo.trcan %>
          </td>

          <!-- Estado actual -->
          <td width="1" class="text-center" style="width:10%">
            <%= f.input :estado_actual,
                        as: :select,
                        collection: ["Pendiente", "Cliente", "Ismael diseño", "Edu diseño", "Miguel diseño",
                                     "Gina", "Diseño 3ro", "Control", "CTP", "Impresión", "Terminación", "Empaque"],
                        label: false,
                        default: "Pendiente" %>
          </td>

          <!-- Proceso (multiselect) -->
          <td>
            <div class="multi-select"
                 id="multiSelect_<%= orden_trabajo.id %>"
                 data-selected="<%= (orden_trabajo.procesos.presence || '').to_s %>">
              <div class="selected-items" id="selectedItems_<%= orden_trabajo.id %>"></div>
              <div class="dropdown-arrow">&#9662;</div>
              <div class="dropdown" id="dropdown_<%= orden_trabajo.id %>">
                <% OrdenTrabajo::POST.each do |valor| %>
                  <div data-value="<%= valor %>"><%= valor %></div>
                <% end %>
              </div>
            </div>

            <%= f.input :procesos,
                        as: :hidden,
                        input_html: { id: "procesos_#{orden_trabajo.id}" } %>
          </td>
          <!-- Campo oculto procesos -->
          <%= f.input :procesos, as: :hidden, input_html: { id: orden_trabajo.id } %>

          <!-- Fecha entrega -->
          <td width="1">
            <%= f.input :deadline,
                        class: 'datepicker',
                        default: Date.today + 15.days,
                        as: :date,
                        html5: true,
                        label: false %>
          </td>

          <!-- Observaciones -->
          <td width="1" class="text-center">
            <%= f.input :observaciones,
                        label: false,
                        placeholder: orden_trabajo.deadline.try(:strftime, '%d-%m') %>
          </td>

          <!-- Botón guardar -->
          <td width="1" class="text-center">
            <%= f.button :submit, "Confirmar",
                        data: { disable_with: 'ok' },
                        class: "btn btn-primary" %>
          </td>

          <!-- Botón eliminar -->
          <td class="text-center align-middle" style="width: 70px;">
            <%= link_to orden_trabajo_path(orden_trabajo),
                        data: { turbo_method: :delete, turbo_confirm: '¿Estás seguro/a?' },
                        class: 'btn btn-danger btn-lg d-flex justify-content-center align-items-center mx-auto' do %>
              <i class="fa-solid fa-trash fa-lg"></i>
            <% end %>

          </td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>
<!-- Campo oculto para reload -->
<input type="hidden" id="refresh" value="no">


